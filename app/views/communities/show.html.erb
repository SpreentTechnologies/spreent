<% content_for :header do %>
  <div class="group w-full h-64 bg-gradient-to-r from-purple-400 to-purple-500 cursor-pointer">
    <% if @community.banner.attached? %>
      <%= image_tag @community.banner, class: "w-full object-cover h-48", alt: "#{@community.name} banner" %>
    <% end %>

    <% if current_user&.owns?(@community) %>
      <!-- Hover overlay that only appears for owners -->
      <div class="absolute inset-0 h-64 bg-black flex items-center opacity-0 group-hover:opacity-25 justify-center transition-opacity duration-200 cursor-pointer"
           data-controller="banner-upload"
           data-action="click->banner-upload#triggerFileInput">
        <div class="text-white text-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <p class="mt-2">Update Banner</p>
        </div>

        <!-- Hidden file input -->
        <%= form_with(model: @community, url: community_path(@community), method: :patch, html: { id: "banner-form", class: "hidden" }) do |form| %>
          <%= form.file_field :banner,
                              direct_upload: true,
                              class: "hidden",
                              data: {
                                banner_upload_target: "fileInput",
                                action: "change->banner-upload#uploadFile"
                              } %>
        <% end %>
      </div>
    <% end %>
      </div>
<% end %>

  <!-- White Card Container -->
    <div class="p-6">
      <!-- Header Section with Title and Action Buttons -->
      <div class="flex justify-between items-center mb-1">
        <h1 class="text-2xl font-bold text-gray-800"><%= @community.name %></h1>
        <div class="flex space-x-2">
          <button class="text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
            </svg>
          </button>
          <button class="text-gray-600">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Subtitle Info -->
      <p class="text-gray-500 text-sm mb-4"><%= @community.sport.name %>, <%= @community.location || 'Worldwide' %>, <%= @community.members.count %> <% if @community.members.count > 1 %>members <% else %>member <% end %></p>

      <!-- Description -->
      <p class="text-gray-700 mb-6">
        <%= @community.description %>
      </p>

      <!-- Action Buttons -->
      <div class="flex space-x-4">
        <% if current_user&.member_of?(@community) %>
          <button class="px-6 py-2 bg-indigo-400 text-white font-medium rounded-full hover:bg-indigo-500 transition duration-200 cursor-pointer">
            Member
          </button>
        <% else %>
          <button class="px-6 py-2 bg-indigo-400 text-white font-medium rounded-full hover:bg-indigo-500 transition duration-200 cursor-pointer" id="join-button">
            <%= I18n.t('community.join_community') %>
          </button>
        <% end %>

        <button id="challenges-button" class="cursor-pointer px-6 py-2 bg-gray-300 text-gray-700 font-medium rounded-full hover:bg-gray-400 transition duration-200">
          <%= I18n.t('community.see_challenges') %>
        </button>
      </div>

    </div>
<hr class="w-full" />

<%= render @community.posts %>


<!-- Sliding Panel Overlay -->
<div id="challenges-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300 opacity-0"></div>

<!-- Challenges Sliding Panel -->
<div id="challenges-panel" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl z-50 transform translate-y-full transition-transform duration-300 ease-in-out">
  <div class="max-w-md mx-auto px-6 py-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-2xl font-semibold text-gray-800"><%= I18n.t('challenges_panel.challenges') %></h2>
      <div class="flex items-center space-x-3">
        <button id="create-challenge-btn" class="text-indigo-500 hover:text-indigo-700 flex items-center cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
          </svg>
          <%= I18n.t('challenges_panel.create') %>
        </button>
        <button id="close-panel" class="text-gray-500 hover:text-gray-700 cursor-pointer">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <h3 class="text-lg font-medium text-gray-700 mb-3"><%= I18n.t('challenges_panel.current_challenges') %></h3>

    <% if @current_challenges.present? %>
      <% @current_challenges.each do |challenge| %>
        <%= link_to challenge_path(challenge), class: 'cursor-pointer' do %>
        <div class="<%= challenge.active? ? 'bg-purple-400 text-white' : 'bg-gray-200' %> rounded-xl p-4 mb-3 flex justify-between items-center">
          <span class="font-medium"><%= challenge.name %></span>
          <span class="text-sm <%= challenge.active? ? '' : 'text-gray-600' %>">
            <% if challenge.starting_soon? %>
              Starting in <%= challenge.days_to_start %> <% if challenge.days_to_start > 1 %>days <% else %>day <% end %>
            <% elsif challenge.active? %>
              <%= I18n.t('challenges_panel.days_left', days_left: challenge.days_left) %>
            <% end %>
          </span>
        </div>
          <% end %>
      <% end %>
    <% else %>
      <div class="bg-gray-100 rounded-xl p-4 mb-3 text-center text-gray-500">
        No current challenges. Create one!
      </div>
    <% end %>

    <% if @past_challenges.present? %>
    <h3 class="text-lg font-medium text-gray-700 mb-3"><%= I18n.t('challenges_panel.past_challenges') %></h3>
      <% @past_challenges.each do |challenge| %>
        <div class="bg-gray-200 rounded-xl p-4 mb-3 flex justify-between items-center">
          <span class="font-medium"><%= challenge.name %></span>
          <span class="text-sm text-gray-600">
            Ended <%= time_ago_in_words(challenge.end_date) %> ago
          </span>
        </div>
      <% end %>
    <% end %>
    <div class="h-18"></div>
  </div>
</div>


<!-- Create Challenge Sliding Panel -->
<div id="create-challenge-panel" class="fixed bottom-[65px] left-0 right-0 bg-white rounded-t-3xl z-50 transform translate-y-full transition-transform duration-300 ease-in-out">
  <div class="max-w-md mx-auto px-6 py-6">
    <!-- Drag handle at the top -->
    <div class="flex justify-center mb-2">
      <div class="w-12 h-1 bg-gray-300 rounded-full"></div>
    </div>

    <div class="text-center mb-4">
      <h2 class="text-2xl font-semibold text-gray-800"><%= I18n.t('create_challenge.create_a_challenge') %></h2>
      <p class="text-gray-600"><%= I18n.t('create_challenge.set_up_goals_for_community') %></p>
    </div>

    <form id="create-challenge-form">
      <div class="mb-4">
        <label for="challenge-name" class="block text-gray-700 font-medium mb-2"><%= I18n.t('create_challenge.challenge_name') %></label>
        <input type="text" id="challenge-name" class="w-full px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="<%= I18n.t('create_challenge.challenge_name_placeholder') %>">
      </div>

      <div class="mb-4">
        <label for="challenge-description" class="block text-gray-700 font-medium mb-2">Description</label>
        <input type="text" id="challenge-description" class="w-full px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="<%= I18n.t('create_challenge.explain_the_goal') %>">
      </div>

      <div class="mb-4">
        <label for="challenge-rules" class="block text-gray-700 font-medium mb-2"><%= I18n.t('create_challenge.rules') %></label>
        <input type="text" id="challenge-rules" class="w-full px-4 py-3 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-300" placeholder="<%= I18n.t('create_challenge.rules_placeholder') %>">
      </div>

      <div class="mb-5">
        <label class="block text-gray-700 font-medium mb-2"><%= I18n.t('create_challenge.duration') %></label>
        <div class="flex space-x-4">
          <div class="flex-1">
            <label for="challenge-start" class="block text-sm text-gray-600 mb-1"><%= I18n.t('create_challenge.starts') %></label>
            <input type="date" id="challenge-start" class="w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-300">
          </div>
          <div class="flex-1">
            <label for="challenge-end" class="block text-sm text-gray-600 mb-1"><%= I18n.t('create_challenge.ends') %></label>
            <input type="date" id="challenge-end" class="w-full px-4 py-2 rounded-lg bg-gray-100 border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-300">
          </div>
        </div>
      </div>

      <button type="submit" class="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white font-medium rounded-full transition duration-200">
        Create Challenge
      </button>
    </form>

    <!-- Close button positioned at the top right -->
    <button id="close-create-panel" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>
  </div>
</div>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const joinButton = document.getElementById('join-button');

        if (joinButton) {
            joinButton.addEventListener('click', function() {
                const communityId = <%= @community.id %>;

                // Show loading state
                joinButton.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      `;
                joinButton.disabled = true;
                joinButton.classList.add('cursor-not-allowed');

                // Send POST request to join the community
                fetch(`/communities/${communityId}/join`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return {};
                    })
                    .then(data => {
                        // Update button to show joined state
                        joinButton.innerHTML = `
          JoinedðŸ‘
        `;
                        joinButton.classList.remove('bg-indigo-400', 'hover:bg-indigo-500');
                        joinButton.classList.add('bg-green-500');

                        // Wait a few seconds...
                        setTimeout(() => {
                            joinButton.classList.add('bg-indigo-400', 'hover:bg-indigo-500');
                            joinButton.classList.remove('bg-green-500');
                            joinButton.innerHTML = 'Member';
                        }, 1000);

                        // Update member count if needed
                        const memberCountEl = document.querySelector('.text-gray-500.text-sm');
                        if (memberCountEl && data.member_count) {
                            const currentText = memberCountEl.textContent;
                            memberCountEl.textContent = currentText.replace(/\d+ members/, `${data.member_count} members`);
                        }
                    })
                    .catch(error => {
                        // Restore button state on error
                        joinButton.innerHTML = 'Join Community';
                        joinButton.disabled = false;
                        joinButton.classList.remove('cursor-not-allowed');

                        console.error('Error joining community:', error);
                        alert('Failed to join community. Please try again.');
                    });
            });
        }

        // Challenges panel functionality
        const challengesButton = document.getElementById('challenges-button');
        const challengesPanel = document.getElementById('challenges-panel');
        const challengesOverlay = document.getElementById('challenges-overlay');
        const closePanel = document.getElementById('close-panel');

        const createButton = document.getElementById('create-challenge-btn');
        const createPanel = document.getElementById('create-challenge-panel');
        const closeCreatePanel = document.getElementById('close-create-panel');
        const createChallengeForm = document.getElementById('create-challenge-form');

        if (document.getElementById('challenge-start')) {
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setMonth(today.getMonth() + 1);

            document.getElementById('challenge-start').valueAsDate = today;
            document.getElementById('challenge-end').valueAsDate = nextMonth;
        }

        // Panel management functions
        function openChallengesPanel() {
            // Close any other open panels first
            closeCreateChallengePanel();

            // Show the overlay and panel
            challengesOverlay.classList.remove('hidden');
            void challengesOverlay.offsetWidth; // Trigger reflow
            challengesOverlay.classList.remove('opacity-0');

            // Slide up the panel
            challengesPanel.classList.remove('translate-y-full');

            // Prevent scrolling on the body
            document.body.classList.add('overflow-hidden');
        }

        function closeChallengesPanel() {
            // Fade out overlay
            challengesOverlay.classList.add('opacity-0');

            // Slide down the panel
            challengesPanel.classList.add('translate-y-full');

            // After transition is complete, hide the overlay completely
            setTimeout(() => {
                challengesOverlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }, 300); // Match the transition duration
        }

        function openCreateChallengePanel() {
            // Close the challenges panel first but keep overlay
            challengesPanel.classList.add('translate-y-full');

            // Make sure overlay is visible
            challengesOverlay.classList.remove('hidden');
            void challengesOverlay.offsetWidth; // Trigger reflow
            challengesOverlay.classList.remove('opacity-0');

            // Show the create challenge panel
            setTimeout(() => {
                createPanel.classList.remove('translate-y-full');
            }, 100); // Small delay for better transition effect

            // Prevent scrolling on the body
            document.body.classList.add('overflow-hidden');
        }

        function closeCreateChallengePanel() {
            // Hide create panel
            createPanel.classList.add('translate-y-full');
        }

        function closeAllPanels() {
            // Close both panels and overlay
            challengesPanel.classList.add('translate-y-full');
            createPanel.classList.add('translate-y-full');

            challengesOverlay.classList.add('opacity-0');

            setTimeout(() => {
                challengesOverlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }, 300);
        }

        // Event listeners for challenges panel
        if (challengesButton) {
            challengesButton.addEventListener('click', openChallengesPanel);
        }

        if (closePanel) {
            closePanel.addEventListener('click', closeChallengesPanel);
        }

        // Event listeners for create panel
        if (createButton) {
            createButton.addEventListener('click', openCreateChallengePanel);
        }

        if (closeCreatePanel) {
            closeCreatePanel.addEventListener('click', closeAllPanels);
        }

        // Overlay click handler
        if (challengesOverlay) {
            challengesOverlay.addEventListener('click', function(event) {
                // Only close if clicked directly on the overlay (not on the panels)
                if (event.target === challengesOverlay) {
                    closeAllPanels();
                }
            });
        }

        if (createChallengeForm) {
            createChallengeForm.addEventListener('submit', function(event) {
                event.preventDefault();

                // Get form values
                const name = document.getElementById('challenge-name').value;
                const description = document.getElementById('challenge-description').value;
                const rules = document.getElementById('challenge-rules').value;
                const startDate = document.getElementById('challenge-start').value;
                const endDate = document.getElementById('challenge-end').value;

                // Validate form
                if (!name || !description || !rules || !startDate || !endDate) {
                    alert('Please fill in all fields');
                    return;
                }

                // Get CSRF token
                const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content;

                // Show loading state
                const submitButton = this.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = `
        <svg class="animate-spin -ml-1 mr-2 h-4 w-4 inline-block text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Creating...
      `;

                // Prepare challenge data
                const challengeData = {
                    challenge: {
                        name: name,
                        description: description,
                        rules: rules,
                        start_date: startDate,
                        end_date: endDate,
                        community_id: <%= @community&.id || 'null' %>
                    }
                };

                // Send POST request to create challenge
                fetch('/challenges', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    body: JSON.stringify(challengeData)
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Request failed with status ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Reset form
                        createChallengeForm.reset();

                        // Show success message
                        alert('Challenge created successfully!');

                        // Close create panel and go back to challenges panel
                        closeCreateChallengePanel();
                        setTimeout(() => {
                            openChallengesPanel();
                        }, 300);
                    })
                    .catch(error => {
                        console.error('Error creating challenge:', error);
                        alert('Failed to create challenge. Please try again.');
                    })
                    .finally(() => {
                        // Restore button state
                        submitButton.disabled = false;
                        submitButton.innerHTML = originalButtonText;
                    });
            });
        }

        function openPanel() {
            // Show the overlay and panel
            challengesOverlay.classList.remove('hidden');
            // Trigger a reflow to enable the transition
            void challengesOverlay.offsetWidth;
            challengesOverlay.classList.remove('opacity-0');

            // Slide up the panel
            challengesPanel.classList.remove('translate-y-full');

            // Prevent scrolling on the body
            document.body.classList.add('overflow-hidden');
        }

        function closePanelFun() {
            // Fade out overlay
            challengesOverlay.classList.add('opacity-0');

            // Slide down the panel
            challengesPanel.classList.add('translate-y-full');

            // After transition is complete, hide the overlay completely
            setTimeout(() => {
                challengesOverlay.classList.add('hidden');
                document.body.classList.remove('overflow-hidden');
            }, 300); // Match the transition duration (300ms)
        }

        // Event listeners
        if (challengesButton) {
            challengesButton.addEventListener('click', openPanel);
        }

        if (closePanel) {
            closePanel.addEventListener('click', closePanelFun);
        }

        if (challengesOverlay) {
            challengesOverlay.addEventListener('click', closePanelFun);
        }

        // Handle escape key press
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape' && !challengesOverlay.classList.contains('hidden')) {
                closePanelFun();
            }
        });
    });
</script>