name: Discord Notification

on:
  workflow_dispatch:
    inputs:
      notification_type:
        description: "Type of notification"
        required: true
        default: "deployment"
        type: choice
        options:
          - deployment
          - release
          - test
      commit_sha:
        description: "Commit SHA"
        required: false
        type: string
      deployed_by:
        description: "Deployed by"
        required: false
        type: string
      deployment_time:
        description: "Deployment time"
        required: false
        type: string
  workflow_call:
    inputs:
      notification_type:
        description: "Type of notification"
        required: true
        type: string
        default: "deployment"
      commit_sha:
        description: "Commit SHA"
        required: false
        type: string
      deployed_by:
        description: "Deployed by"
        required: false
        type: string
      deployment_time:
        description: "Deployment time"
        required: false
        type: string
    secrets:
      DISCORD_WEBHOOK:
        required: true

jobs:
  notify:
    name: Send Discord Notification
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Send deployment notification
        env:
          DISCORD_WEBHOOK: "https://discord.com/api/webhooks/1365763555219214418/6pvvn44yuPjkS1O_CG_oe0jztT2aAtwW1WQuGH8lwmtfMJYQWa6AhdffwbygR-gi7kAm"
          COMMIT_SHA: ${{ inputs.commit_sha || github.sha }}
          DEPLOYED_BY: ${{ inputs.deployed_by || github.actor }}
          DEPLOYMENT_TIME: ${{ inputs.deployment_time }}
        run: |
          RELEASE_NAME="${{ github.event.release.name }}"
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RELEASE_URL="${{ github.event.release.html_url }}"
          RELEASE_AUTHOR="${{ github.event.release.author.login }}"
          RELEASE_BODY="${{ github.event.release.body }}"
          
          # Truncate body if too long
          if [ ${#RELEASE_BODY} -gt 1500 ]; then
            RELEASE_BODY="${RELEASE_BODY:0:1500}...\n\n*[Content truncated. See full release notes at the link below]*"
          fi
          
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [
              {
                "title": "ðŸš€Nouvelle version: $RELEASE_NAME ($RELEASE_TAG)",
                "description": "$RELEASE_BODY",
                "url": "$RELEASE_URL",
                "color": 5793266,
                "fields": [
                  {
                    "name": "Released by",
                    "value": "$RELEASE_AUTHOR",
                    "inline": true
                  },
                  {
                    "name": "Repository",
                    "value": "${{ github.repository }}",
                    "inline": true
                  }
                ],
                "footer": {
                  "text": "Released at ${{ github.event.release.published_at }}"
                }
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H "Content-Type: application/json" -d "$PAYLOAD" $DISCORD_WEBHOOK