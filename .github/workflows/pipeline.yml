name: Full CI/CD Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    name: Test Application
    uses: ./.github/workflows/rails-test.yml
    secrets:
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      MYSQL_ROOT_PASSWORD: Dx1g4t8ds

  create-release:
    name: Create Release
    needs: test
    uses: ./.github/workflows/auto-release.yml

  deploy:
    name: Deploy Application
    needs: [test, create-release]
    uses: ./.github/workflows/kamal-deploy.yml
    secrets:
      RAILS_MASTER_KEY: ${{ secrets.RAILS_MASTER_KEY }}
      KAMAL_REGISTRY_USERNAME: ${{ secrets.KAMAL_REGISTRY_USERNAME }}
      MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
      SERVER_IP: ${{ secrets.SERVER_IP }}